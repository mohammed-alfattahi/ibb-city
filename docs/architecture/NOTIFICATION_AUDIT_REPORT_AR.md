# ๐ ุชูุฑูุฑ ูุญุต ูุธุงู ุงูุฅุดุนุงุฑุงุช (Notification Audit)

ุจูุงุกู ุนูู ุทูุจููุ ูููุง ุจุชุชุจุน ูุณุงุฑ ุงูุฅุดุนุงุฑุงุช "ูููุงู ุจููู" ูุฅุฌุฑุงุก ุงุฎุชุจุงุฑ ุนููู ููููุฏ. ุฅูููู ุงููุชุงุฆุฌ:

---

## 1. ูุชูุฌุฉ ุงููุญุต ุงูุนููู (Trace Results)
ุชู ุชุดุบูู ุณูุฑุจุช ุงูุชุชุจุน `trace_notifications` ูุฃุนุทู ุงููุชุงุฆุฌ ุงูุชุงููุฉ:

| ุงูุงุฎุชุจุงุฑ | ุงููุชูุฌุฉ | ุงููุนูู |
| :--- | :--- | :--- |
| **ุฅุดุนุงุฑ ุงูุฅุฏุงุฑุฉ (Admin)** | โ **ูุงุฌุญ** | ุงููุธุงู ูุชุนุฑู ุนูู ุงููุณุชุฎุฏููู ุจุตูุงุญูุฉ `is_staff` ููุฑุณู ููู ุงูุชูุจููุงุช. |
| **ุฅุดุนุงุฑ ุงูุดุฑูู (Role)** | โ **ูุงุฌุญ** | ุงููุธุงู ูุฑุณู "ุชูุจููุงุช ุนุงูุฉ" ููุดุฑูุงุก ุจูุงุกู ุนูู ุงูุฏูุฑ (`Role`). |
| **ุฅุดุนุงุฑ ูุจุงุดุฑ (User ID)** | โ **ูุงุฌุญ** | ุงููุธุงู ูุฑุณู ุฅุดุนุงุฑุงุช (ูุซู ุชูููู ุฌุฏูุฏ) ููุดุฑูู ุตุงุญุจ ุงูููุดุฃุฉ ูุจุงุดุฑุฉ. |
| **ุฅุดุนุงุฑุงุช ุงูุณุงุฆุญ** | โ **ูุงุฌุญ** | ุชู ุงูุชุญูู ูู ูุตูู ุงูุฑุฏูุฏ ุนูู ุงูุชุนูููุงุช ูุชุญุฏูุซุงุช ุงูุจูุงุบุงุช ููุณุงุฆุญ. |
| **ุจุซ ุงูุทูุณ (Weather)** | โ **ูุงุฌุญ** | ุชู ุฅุฑุณุงู ุชูุจูู ุทูุณ ุงุณุชููุชู ุฌููุน ุงูุฃุทุฑุงู (ุฅุฏุงุฑุฉุ ุดุฑูุงุกุ ุณูุงุญ). |
| **ุชูุจููุงุช ุงููุธุงู (SystemAlert)** | โ **ูุงุฌุญ** | ุชู ุงูุชุญูู ูู ูุฌุงุญ ูููุฐุฌ `SystemAlert` ูู ุฅุฑุณุงู ุจุซ ูุณุชูุฏู ูู ููุญุฉ ุงูุฅุฏุงุฑุฉ. |

---

## 2. ุชุญุฏูุซุงุช "ุฑูุงุจุท ุงูุฅุฌุฑุงุก" (Action URLs)
ุชู ุชุทููุฑ ุงููุธุงู ููุตุจุญ ุชูุงุนููุงู (`Actionable Notifications`). ุนูุฏ ุงูุถุบุท ุนูู ุงูุฅุดุนุงุฑ:
* **ุงูุดุฑูู**: ููุชูู ุฅูู ููุญุฉ ุงูุชุญูู ุงูุฎุงุตุฉ ุจู.
* **ุงูุฅุฏุงุฑุฉ**: ุชูุชูู ุฅูู ุชูุงุตูู ุงูุทูุจ ุฃู ุงูููุดุฃุฉ.
* **ุงูุณุงุฆุญ**: ููุชูู ุฅูู ุตูุญุฉ ุงููุนูู ุงูุณูุงุญู.
* **ุชูุจูู ุงูุทูุณ**: ูููู ุงูุฌููุน ุฅูู ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ ุญุงููุงู (ูููู ุชุฎุตูุต ุตูุญุฉ ุทูุงุฑุฆ ูุงุญูุงู).

---

## 2. ุชุญููู ุงูููุฏ (Code Analysis)

### ุฃ. ููู ุงูุฅุดุงุฑุงุช `interactions/signals.py`
โ **ุณููู ุชูุงูุงู.**
*   ูุชู ุงูุชูุงุท ุญุฏุซ `NEW_PARTNER_REGISTRATION` ูุฅุฑุณุงูู ููุฅุฏุงุฑุฉ.
*   ูุชู ุงูุชูุงุท ุญุฏุซ `NEW_ESTABLISHMENT_REQUEST` ูุฅุฑุณุงูู ููุฅุฏุงุฑุฉ.
*   ูุชู ุงูุชูุงุท ุญุฏุซ `NEW_REVIEW` ูุฅุฑุณุงูู ูุตุงุญุจ ุงูููุงู.

### ุจ. ููู ุงูุฎุฏูุฉ `notification_service.py`
โ **Logic ุตุญูุญ.**
*   ูููู ุจุญู ุงูุฌูููุฑ (`_resolve_audience`) ุจุดูู ุฏููู ุณูุงุก ูุงููุง ูุดุฑููู ุฃู ุดุฑูุงุก.
*   ูููู ุจุฅูุดุงุก ุณุฌูุงุช `Notification` ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช (ููู ูุง ูุธูุฑ ูู ุฃููููุฉ ุงูุฌุฑุณ ูู ุงููููุน).

---

## 3. ุชูุถูุญ ุฑุณุงุฆู ุงูุฎุทุฃ (The "Failed" Logs)
ุฃุซูุงุก ุงูุงุฎุชุจุงุฑ ุธูุฑุช ุฑุณุงุฆู ูุซู:
`Outbox ... failed (non-retriable): No device token registered`

**โ๏ธ ูุฐุง ููุณ ุฎุทุฃ ุจุฑูุฌูุงู ุฎุทูุฑุงูุ ุจู ูู ุณููู ุทุจูุนู ูุฃู:**
1.  ูุญู ูุฎุชุจุฑ ูุณุชุฎุฏููู ูููููู (`trace_admin`, `trace_partner`).
2.  ูุคูุงุก ุงููุณุชุฎุฏููู ูู ูุณุฌููุง ุงูุฏุฎูู ูู ุชุทุจูู ููุจุงููุ ูุจุงูุชุงูู ููุณ ูุฏููู `fcm_token`.
3.  ุงููุธุงู ููุฌุญ ูู ุฅูุดุงุก ุฅุดุนุงุฑ ุงูููุจ (In-App)ุ ูููู ูุชุฎุทู ุฅุดุนุงุฑ ุงูููุจุงูู (Push) ูุนุฏู ูุฌูุฏ ูุงุชู.

**ุงูุญู ุงูููุชุฑุญ (ุงุฎุชูุงุฑู):**
ุฅุฐุง ุฃุฑุฏุช ุฅุฎูุงุก ูุฐู ุงูุฑุณุงุฆู ุงูุญูุฑุงุกุ ูููููุง ุฅุถุงูุฉ ุดุฑุท ุจุณูุท ูู ุงูููุฏ: "ูุง ุชุญุงูู ุฅุฑุณุงู Push Notification ุฅูุง ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูููู `fcm_token`".

---

## 4. ุงูุฎูุงุตุฉ
ูุธุงู ุงูุฅุดุนุงุฑุงุช ุจูู **ุงูุดุฑูู ูุงูุฅุฏุงุฑุฉ** ูุจูู **ุงูุฅุฏุงุฑุฉ ูุงููุณุชุฎุฏููู** ูุนูู ุจุดูู ุณููู 100% ุฏุงุฎู ุงููููุน (ูุงุนุฏุฉ ุงูุจูุงูุงุช). ุงููุดููุฉ ุงููุญูุฏุฉ ุงูุธุงูุฑุฉ ูู ููุท "ุชูุจููุงุช" ุจุฎุตูุต ุบูุงุจ ุงูููุงุชู ุงููุญูููุฉ ูููุณุชุฎุฏููู ุงููููููู.

ููููู ุงูุงุทูุฆูุงู ูุงุนุชูุงุฏ ุงููุธุงู ุงูุญุงูู.
