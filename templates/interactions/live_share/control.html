{% extends "base_app.html" %}
{% load static %}
{% load i18n %}

{% block title %}ูุดุงุฑูุฉ ุงููููุน ุงููุจุงุดุฑ{% endblock %}

{% block content %}
<div class="container py-5 text-center">
    <div class="card shadow rounded-4 mx-auto" style="max-width: 500px;">
        <div class="card-body p-5">
            <h1 class="mb-4">๐ด ูุดุงุฑูุฉ ุงููููุน ูุดุทุฉ</h1>

            <div class="alert alert-success d-flex align-items-center mb-4">
                <div class="spinner-grow spinner-grow-sm text-success me-2" role="status"></div>
                <div>ุฌุงุฑู ุฅุฑุณุงู ูููุนู ูู 15 ุซุงููุฉ...</div>
            </div>

            <p class="text-muted mb-4">ุดุงุฑู ูุฐุง ุงูุฑุงุจุท ููุชููู ุงูุขุฎุฑูู ูู ูุชุงุจุนุชู:</p>

            <div class="input-group mb-4">
                <input type="text" class="form-control" id="shareLink"
                    value="{{ request.scheme }}://{{ request.get_host }}{% url 'live_share_public' session.token %}"
                    readonly>
                <button class="btn btn-outline-primary" onclick="copyLink()">ูุณุฎ</button>
            </div>

            <button onclick="stopSharing()" class="btn btn-danger btn-lg w-100 rounded-pill">ุฅููุงู ุงููุดุงุฑูุฉ</button>

            <p id="statusMsg" class="mt-3 text-muted small"></p>
        </div>
    </div>
</div>

<script>
    let watchId;
    const token = "{{ session.token }}";

    function copyLink() {
        const copyText = document.getElementById("shareLink");
        copyText.select();
        document.execCommand("copy");
        alert("ุชู ูุณุฎ ุงูุฑุงุจุท!");
    }

    function stopSharing() {
        if (!confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ุฅููุงู ุงููุดุงุฑูุฉุ")) return;

        navigator.geolocation.clearWatch(watchId);
        fetch(`/share/stop/${token}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        }).then(() => {
            window.location.href = "{% url 'home' %}";
        });
    }

    // Start Watching Location
    if (navigator.geolocation) {
        watchId = navigator.geolocation.watchPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                document.getElementById('statusMsg').innerText = `ุชู ุงูุชุญุฏูุซ: ${new Date().toLocaleTimeString()}`;

                // Ping Server
                fetch("{% url 'live_share_ping' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: `token=${token}&lat=${lat}&lon=${lon}`
                });
            },
            (error) => {
                console.error(error);
                alert("ุชุนุฐุฑ ุงููุตูู ูููููุน. ูุฑุฌู ุชูุนูู GPS.");
            },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
    } else {
        alert("ุงููุชุตูุญ ูุง ูุฏุนู ุชุญุฏูุฏ ุงููููุน.");
    }
</script>
{% endblock %}