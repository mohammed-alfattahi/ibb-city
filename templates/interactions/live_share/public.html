{% extends "base_app.html" %}
{% load static %}

{% block title %}متابعة الموقع المباشر{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    #map {
        height: 100vh;
        width: 100%;
        top: 0;
        position: fixed;
        z-index: 100;
    }

    .overlay-card {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        background: white;
        padding: 15px 25px;
        border-radius: 50px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        gap: 15px;
    }
</style>
{% endblock %}

{% block body_content %}
<div id="map"></div>

<div class="overlay-card">
    <div class="spinner-grow spinner-grow-sm text-danger" role="status"></div>
    <div class="fw-bold">بث حي للموقع</div>
    <div class="vr"></div>
    <div id="last-updated" class="text-muted small">جاري الاتصال...</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([13.9667, 44.1833], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const marker = L.marker([13.9667, 44.1833]).addTo(map)
        .bindPopup("موقع المستخدم").openPopup();

    const token = "{{ session.token }}";

    function updateLocation() {
        fetch(`/share/${token}/latest/`)
            .then(res => res.json())
            .then(data => {
                if (data.lat) {
                    const newLatLng = new L.LatLng(data.lat, data.lon);
                    marker.setLatLng(newLatLng);
                    map.panTo(newLatLng);
                    document.getElementById('last-updated').innerText = "آخر تحديث: " + new Date().toLocaleTimeString();
                }
            });
    }

    // Poll every 5 seconds
    setInterval(updateLocation, 5000);
    updateLocation();
</script>
{% endblock %}