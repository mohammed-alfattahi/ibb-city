{% load humanize %}
<div id="review-{{ review.pk }}"
    class="card border-0 shadow-sm rounded-4 p-4 transition-all hover-shadow-md mb-3 animate__animated animate__fadeIn {% if review.visibility_state != 'visible' %}bg-light opacity-75 border border-warning{% endif %}">
    <div class="d-flex gap-3">
        <div class="flex-shrink-0">
            <img src="https://ui-avatars.com/api/?name={{ review.user.username }}&background=random&size=128"
                class="review-avatar shadow-sm object-fit-cover" width="56" height="56"
                style="border-radius: 16px;">
        </div>
        <div class="flex-grow-1">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                    <h6 class="fw-bold mb-0 text-dark d-flex align-items-center gap-2">
                        {{ review.user.get_full_name|default:review.user.username }}
                        {% if review.user == place.establishment.owner %}
                        <span class="badge bg-primary-subtle text-primary rounded-pill px-2 py-1"
                            style="font-size: 0.65em;">
                            <i class="fas fa-check-circle me-1"></i> المالك
                        </span>
                        {% endif %}
                    </h6>
                    <small class="text-muted" style="font-size: 0.8rem;">{{ review.created_at|naturaltime }}</small>
                    {% if review.is_edited %}
                    <small class="text-muted ms-1 fst-italic">(تم التعديل)</small>
                    {% endif %}
                </div>
                <div class="d-flex gap-1 text-warning small bg-light px-2 py-1 rounded-pill">
                    {% with ''|center:review.rating as range %}
                    {% for _ in range %}<i class="fas fa-star"></i>{% endfor %}
                    {% endwith %}
                </div>
            </div>

            <p class="text-secondary mb-3 fs-6" style="line-height: 1.6;">{{ review.comment }}</p>

            <!-- Reply Button (all authenticated users) -->
            {% if user.is_authenticated %}
            <div class="d-flex gap-2 mb-2 pt-2 border-top">
                <button class="btn btn-sm btn-light text-primary rounded-pill px-3"
                    onclick="toggleReplyForm('reply-form-{{ review.id }}')">
                    <i class="fas fa-reply me-1"></i> رد
                </button>
            </div>
            {% endif %}

            <!-- Partner Controls (owner only) -->
            {% if user.is_authenticated and place.establishment.owner == user %}
            <div class="d-flex gap-2 mb-3">
                <form action="{% url 'toggle_comment_visibility' pk=review.pk model_type='review' %}"
                    method="post" class="d-inline">
                    {% csrf_token %}
                    {% if review.visibility_state == 'visible' %}
                    <input type="hidden" name="reason" value="Hidden by partner">
                    <button type="submit" class="btn btn-sm btn-light text-muted rounded-pill px-3">
                        <i class="fas fa-eye-slash me-1"></i> إخفاء
                    </button>
                    {% elif review.visibility_state == 'partner_hidden' %}
                    <input type="hidden" name="reason" value="">
                    <button type="submit" class="btn btn-sm btn-light text-success rounded-pill px-3">
                        <i class="fas fa-eye me-1"></i> إظهار
                    </button>
                    {% endif %}
                </form>
            </div>
            {% endif %}

            <!-- Reply Input (all authenticated users) -->
            {% if user.is_authenticated %}
            <div id="reply-form-{{ review.id }}" class="mt-3 d-none animate__animated animate__fadeIn">
                <form action="{% url 'add_reply' review_pk=review.pk %}" method="post"
                    class="position-relative">
                    {% csrf_token %}
                    <textarea name="content" class="form-control bg-light border-0 rounded-4 p-3 pe-5" rows="2"
                        placeholder="اكتب ردك هنا..." style="resize: none;"></textarea>
                    <button type="submit"
                        class="btn btn-primary btn-sm rounded-circle position-absolute bottom-0 end-0 m-2 shadow-sm"
                        style="width: 32px; height: 32px;">
                        <i class="fas fa-paper-plane text-white small"></i>
                    </button>
                </form>
            </div>
            {% endif %}

            <!-- Replies Thread -->
            {% if review.replies.all %}
            <div class="mt-3 d-flex flex-column gap-2">
                {% for reply in review.replies.all %}
                {% if reply.visibility_state == 'visible' or place.establishment.owner == user %}
                <div
                    class="d-flex gap-3 bg-light bg-opacity-50 p-3 rounded-4 border-start border-4 border-primary position-relative">
                    <div class="flex-shrink-0">
                        {% if reply.user == place.establishment.owner %}
                        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center shadow-sm"
                            style="width: 32px; height: 32px;">
                            <i class="fas fa-store small"></i>
                        </div>
                        {% else %}
                        <img src="https://ui-avatars.com/api/?name={{ reply.user.username }}&background=random"
                            class="rounded-circle shadow-sm" width="32" height="32">
                        {% endif %}
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <h6 class="fw-bold mb-0 font-size-sm">
                                {{ reply.user.get_full_name|default:reply.user.username }}
                                {% if reply.user == place.establishment.owner %}
                                <span class="text-primary small ms-1">● رد المالك</span>
                                {% endif %}
                            </h6>
                            <small class="text-muted extra-small">{{ reply.created_at|timesince }}</small>
                        </div>
                        <p class="mb-0 text-secondary small">{{ reply.content }}</p>

                        <!-- Reply Actions -->
                        {% if user == place.establishment.owner %}
                        <div class="position-absolute top-0 end-0 m-2 opacity-50 hover-opacity-100">
                            <form
                                action="{% url 'toggle_comment_visibility' pk=reply.pk model_type='comment' %}"
                                method="post">
                                {% csrf_token %}
                                {% if reply.visibility_state == 'visible' %}
                                <button class="btn btn-link btn-sm text-muted p-0" title="إخفاء"><i
                                        class="fas fa-eye-slash"></i></button>
                                {% else %}
                                <button class="btn btn-link btn-sm text-success p-0" title="إظهار"><i
                                        class="fas fa-eye"></i></button>
                                {% endif %}
                            </form>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
            {% endif %}

        </div>
    </div>
    {% if review.visibility_state != 'visible' %}
    <div class="position-absolute top-0 start-0 m-3">
        <span class="badge bg-danger rounded-pill shadow-sm"><i class="fas fa-eye-slash me-1"></i> مخفي عن
            الجمهور</span>
    </div>
    {% endif %}
</div>
