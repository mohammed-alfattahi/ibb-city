{% extends "partners/base_partner.html" %}
{% load humanize %}

{% block title %}إدارة العروض السياحية - شريك النجاح{% endblock %}

{% block content %}
<div class="container-fluid p-0 animate__animated animate__fadeIn">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-1 text-dark">عروضي السياحية</h2>
            <p class="text-muted mb-0">إدارة العروض والخدمات والخصومات المروجة للزوار.</p>
        </div>
        <div>
            <a href="{% url 'ad_create' %}"
                class="btn btn-primary rounded-pill shadow-sm fw-bold px-4 py-2 d-flex align-items-center gap-2">
                <i class="fas fa-plus"></i>
                <span class="d-none d-md-inline">إضافة عرض جديد</span>
            </a>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="elite-card p-4 h-100">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="stat-label">قيد المراجعة</span>
                    <div class="icon-box bg-orange-50 text-orange-500" style="background: #fff7ed; color: #f97316;">
                        <i class="fas fa-clock"></i>
                    </div>
                </div>
                <div class="stat-value">{{ pending_count }}</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="elite-card p-4 h-100">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="stat-label">عروض نشطة</span>
                    <div class="icon-box bg-green-50 text-green-600" style="background: #f0fdf4; color: #16a34a;">
                        <i class="fas fa-check-circle"></i>
                    </div>
                </div>
                <div class="stat-value">{{ active_count }}</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="elite-card p-4 h-100">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="stat-label">إجمالي المشاهدات</span>
                    <div class="icon-box bg-blue-50 text-blue-600">
                        <i class="fas fa-eye"></i>
                    </div>
                </div>
                <div class="stat-value">{{ total_views|default:"0"|intcomma }}</div>
            </div>
        </div>
    </div>

    <!-- Offers Grid -->
    <div class="row g-4">
        {% for ad in ads %}
        <div class="col-md-6 col-lg-4 col-xl-3">
            <div id="ad-{{ ad.pk }}" class="elite-card p-0 d-flex flex-column h-100 overflow-hidden">
                <!-- Image & Status -->
                <div class="position-relative" style="height: 180px;">
                    <div class="position-absolute top-0 start-0 m-3 z-1">
                        {% if ad.status == 'active' %}
                        <span class="badge bg-success shadow-sm rounded-pill px-3 py-2"><i
                                class="fas fa-check-circle me-1"></i> نشط</span>
                        {% elif ad.status == 'pending' %}
                        <span class="badge bg-warning text-dark shadow-sm rounded-pill px-3 py-2"><i
                                class="fas fa-clock me-1"></i> قيد المراجعة</span>
                        {% elif ad.status == 'expired' %}
                        <span class="badge bg-secondary shadow-sm rounded-pill px-3 py-2"><i
                                class="fas fa-history me-1"></i> منتهي</span>
                        {% elif ad.status == 'rejected' %}
                        <span class="badge bg-danger shadow-sm rounded-pill px-3 py-2"><i
                                class="fas fa-times-circle me-1"></i> مرفوض</span>
                        {% elif ad.status == 'payment_issue' %}
                        <span class="badge bg-danger shadow-sm rounded-pill px-3 py-2"><i
                                class="fas fa-exclamation-triangle me-1"></i> مشكلة دفع</span>
                        {% endif %}
                    </div>

                    {% if ad.banner_image %}
                    <img src="{{ ad.banner_image.url }}"
                        class="w-100 h-100 object-fit-cover transition-transform hover-scale" alt="{{ ad.title }}">
                    {% else %}
                    <div
                        class="w-100 h-100 d-flex align-items-center justify-content-center bg-gray-100 text-muted opacity-50">
                        <i class="fas fa-image fa-3x"></i>
                    </div>
                    {% endif %}
                </div>

                <div class="p-4 flex-grow-1 d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <small class="text-primary fw-bold text-uppercase ls-wider" style="font-size: 0.7rem;">{{ ad.place.name }}</small>
                    </div>
                    <h5 class="fw-bold mb-3 text-dark text-truncate" title="{{ ad.title }}">{{ ad.title }}</h5>

                    <!-- Price -->
                    <div class="mb-3">
                        {% if ad.discount_price %}
                        <span class="fw-bold text-success fs-5">{{ ad.discount_price }} ر.ي</span>
                        <span class="text-decoration-line-through text-muted small ms-2">{{ ad.price }} ر.ي</span>
                        {% elif ad.price %}
                        <span class="fw-bold text-dark fs-5">{{ ad.price }} ر.ي</span>
                        {% else %}
                        <span class="badge bg-light text-dark border">سعر عند الطلب</span>
                        {% endif %}
                    </div>

                    <div
                        class="d-flex justify-content-between align-items-center text-muted small mb-4 py-2 border-top border-bottom">
                        <span><i class="far fa-calendar-alt me-1 text-primary"></i> {{ ad.duration_days }} يوم</span>
                        <span><i class="far fa-eye me-1 text-primary"></i> {{ ad.views }}</span>
                    </div>

                    <!-- Actions -->
                    <div class="mt-auto">
                        {% if ad.status == 'pending' and not ad.receipt_image or ad.status == 'payment_issue' %}
                        <a href="{% url 'ad_payment' ad.pk %}"
                            class="btn btn-warning w-100 rounded-pill fw-bold shadow-sm d-flex align-items-center justify-content-center gap-2">
                            <i class="fas fa-receipt"></i> رفع السند
                        </a>
                        {% else %}
                        <a href="{% url 'ad_update' ad.pk %}"
                            class="btn btn-light w-100 rounded-pill fw-bold text-dark border hover-bg-gray-50 transition-all text-decoration-none d-flex align-items-center justify-content-center">
                            <i class="fas fa-edit me-2 text-muted"></i> تعديل / تفاصيل
                        </a>
                        {% endif %}

                        {% if ad.status == 'rejected' and ad.admin_notes %}
                        <div
                            class="mt-3 bg-danger bg-opacity-10 p-2 rounded small text-danger border border-danger border-opacity-25">
                            <strong>سبب الرفض:</strong> {{ ad.admin_notes }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12 py-5 text-center">
            <div class="mb-4">
                <div class="bg-gray-100 rounded-circle d-inline-flex align-items-center justify-content-center"
                    style="width: 100px; height: 100px;">
                    <i class="fas fa-tags fa-3x text-muted opacity-25"></i>
                </div>
            </div>
            <h4 class="text-dark fw-bold">لا توجد عروض منشورة</h4>
            <p class="text-muted mb-4">هذه فرصتك لجذب عملاء جدد! ابدأ بنشر عرضك الأول.</p>
            <a href="{% url 'ad_create' %}" class="btn btn-primary rounded-pill px-5 py-2 fw-bold shadow-sm">
                نشر عرض سياحي
            </a>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}