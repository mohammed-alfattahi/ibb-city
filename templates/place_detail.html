{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block title %}{{ place.name }} - {{ block.super }}{% endblock %}

{% block meta_tags %}
<meta name="description" content="{{ place.description|striptags|truncatechars:155 }}">
<!-- Open Graph / Facebook -->
<meta property="og:type" content="article">
<meta property="og:url" content="{{ request.build_absolute_uri }}">
<meta property="og:title" content="{{ place.name }}">
<meta property="og:description" content="{{ place.description|striptags|truncatechars:155 }}">
{% if place.cover_image %}
<meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{{ place.cover_image.url }}">
{% else %}
<meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{% static 'images/placeholder_cover.jpg' %}">
{% endif %}

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:url" content="{{ request.build_absolute_uri }}">
<meta property="twitter:title" content="{{ place.name }}">
<meta property="twitter:description" content="{{ place.description|striptags|truncatechars:155 }}">
{% if place.cover_image %}
<meta property="twitter:image" content="{{ request.scheme }}://{{ request.get_host }}{{ place.cover_image.url }}">
{% else %}
<meta property="twitter:image" content="{{ request.scheme }}://{{ request.get_host }}{% static 'images/placeholder_cover.jpg' %}">
{% endif %}
{% endblock %}

{% block content %}
<!-- Use a distinct container to avoid affecting the global styles unexpectedly -->
<div class="place-detail-container">

    <!-- HERO SECTION -->
    <div class="position-relative w-100 mb-5" style="height: 500px; border-radius: 0 0 30px 30px; overflow: hidden;">
        {% if place.cover_image %}
        <img src="{{ place.cover_image.url }}" class="w-100 h-100 object-fit-cover property-hero-img"
            alt="{{ place.name }}">
        {% else %}
        <img src="{% static 'images/placeholder_cover.jpg' %}" class="w-100 h-100 object-fit-cover"
            alt="{{ place.name }}">
        {% endif %}
        <!-- Gradient Overlay -->
        <div class="position-absolute top-0 start-0 w-100 h-100"
            style="background: linear-gradient(to bottom, rgba(0,0,0,0.2) 0%, rgba(0,0,0,0.7) 100%);">
        </div>

        <!-- Hero Content -->
        <div class="position-absolute bottom-0 start-0 w-100 p-4 p-md-5 text-white">
            <div class="container">
                <div class="d-flex justify-content-between align-items-end flex-wrap">
                    <div>
                        <div class="mb-2">
                            {% if place.category %}
                            <span class="badge bg-primary bg-opacity-75 backdrop-blur me-2 rounded-pill px-3 py-2">
                                <i class="fas fa-tag me-1"></i> {{ place.category.name }}
                            </span>
                            {% endif %}
                            <span class="badge bg-light text-dark bg-opacity-90 backdrop-blur rounded-pill px-3 py-2">
                                <i class="fas fa-star text-warning me-1"></i> {{ place.avg_rating|default:"New" }}
                            </span>
                            <!-- Status Badge -->
                            <span
                                class="badge bg-{{ place.status_css_class }} bg-opacity-90 backdrop-blur rounded-pill px-3 py-2 ms-1">
                                <i class="fas {{ place.status_icon }} me-1"></i>
                                {{ place.get_operational_status_display }}
                            </span>

                            <!-- Closing Alert Badge -->
                            {% if closing_status.state == 'closing_soon' %}
                            <span
                                class="badge bg-warning text-dark bg-opacity-90 backdrop-blur rounded-pill px-3 py-2 ms-1 animate__animated animate__pulse animate__infinite">
                                <i class="fas fa-hourglass-half me-1"></i> Closing in {{ closing_status.minutes }} min
                            </span>
                            {% elif closing_status.state == 'closed' %}
                            <span class="badge bg-danger bg-opacity-90 backdrop-blur rounded-pill px-3 py-2 ms-1">
                                <i class="fas fa-moon me-1"></i> Closed Now
                            </span>
                            {% elif closing_status.state == 'open' %}
                            <span class="badge bg-success bg-opacity-90 backdrop-blur rounded-pill px-3 py-2 ms-1">
                                <i class="fas fa-clock me-1"></i> Open Now
                            </span>
                            {% endif %}
                        </div>
                        <h1 class="display-3 fw-bold mb-2 text-shadow">
                            {{ place.name }}
                            {% if place.establishment and place.establishment.is_badged %}
                            <span class="badge bg-success bg-opacity-90 rounded-pill px-3 py-2 fs-6 ms-2 align-middle shadow-sm" 
                               data-bs-toggle="tooltip" 
                               data-bs-title="Ÿáÿ∞Ÿá ÿßŸÑŸÖŸÜÿ¥ÿ£ÿ© ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜŸáÿß ŸàŸÖÿπÿ™ŸÖÿØÿ© ÿ±ÿ≥ŸÖŸäÿßŸã">
                                <i class="fas fa-check-circle me-1"></i>ŸÖŸÜÿ¥ÿ£ÿ© ŸÖŸàÿ´ŸÇÿ©
                            </span>
                            {% endif %}
                        </h1>
                        <p class="lead mb-0 text-white-50"><i class="fas fa-map-marker-alt me-2 text-danger"></i>
                            {{ place.directorate }} - {{ place.address_text }}
                        </p>
                    </div>
                    <div class="d-flex gap-3 mt-3 mt-md-0">
                        <button class="btn btn-light btn-lg rounded-pill px-4 shadow-sm" onclick="scrollToReview()">
                            <i class="fas fa-pen me-2"></i> {% trans "Write a Review" %}
                        </button>

                        <!-- Favorites Button Wrapper -->
                        <div id="fav-btn-wrap-{{ place.id }}" class="d-inline-block">
                            {% include "partials/favorite_button.html" with is_fav=is_favorited %}
                        </div>

                        <button class="btn btn-outline-light btn-lg rounded-pill px-4 backdrop-blur hover-scale"
                            onclick="sharePlace()">
                            <i class="fas fa-share-alt me-2"></i> {% trans "Share" %}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN CONTENT GRID -->
    <div class="container pb-5">
        <div class="row g-4">

            <!-- LEFT COLUMN (Details & Gallery) -->
            <div class="col-lg-8">

                <!-- Verified Establishment Banner -->
                {% if place.establishment and place.establishment.is_badged %}
                <div class="card border-0 shadow-sm rounded-4 mb-4 overflow-hidden border-start border-5 border-success">
                    <div class="card-body p-4 bg-success bg-opacity-10">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-shield-alt text-success fs-4 me-3"></i>
                            <h6 class="fw-bold text-success mb-0">ŸÖŸÜÿ¥ÿ£ÿ© ŸÖŸàÿ´ŸÇÿ© ŸàŸÖÿπÿ™ŸÖÿØÿ©</h6>
                        </div>
                        <p class="text-muted small mb-2">Ÿáÿ∞Ÿá ÿßŸÑŸÖŸÜÿ¥ÿ£ÿ© ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ®ŸäÿßŸÜÿßÿ™Ÿáÿß ŸàÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿµÿ≠ÿ™Ÿáÿß:</p>
                        <div class="d-flex flex-wrap gap-3">
                            <span class="text-success small"><i class="fas fa-check me-1"></i>ŸáŸàŸäÿ© ÿßŸÑŸÖÿßŸÑŸÉ</span>
                            <span class="text-success small"><i class="fas fa-check me-1"></i>ÿßŸÑÿ™ÿ±ÿÆŸäÿµ</span>
                            <span class="text-success small"><i class="fas fa-check me-1"></i>ÿßŸÑŸÖŸàŸÇÿπ ÿßŸÑŸÅÿπŸÑŸä</span>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Special Offers Section -->
                {% if active_offers %}
                <div class="card border-0 shadow-sm rounded-4 mb-4 overflow-hidden border-start border-5 border-danger">
                    <div class="card-body p-4 bg-danger bg-opacity-10">
                        <h4 class="fw-bold text-danger mb-3">
                            <i class="fas fa-tags me-2"></i>{% trans "Special Offers & Discounts" %}
                        </h4>
                        <div class="row g-3">
                            {% for offer in active_offers %}
                            <div class="col-md-6">
                                <div class="card h-100 border-0 shadow-sm hover-scale transition-all">
                                    {% if offer.image %}
                                    <div class="position-relative">
                                        <img src="{{ offer.image.url }}" class="card-img-top object-fit-cover"
                                            alt="{{ offer.title }}" style="height: 140px;">
                                        <div class="position-absolute top-0 end-0 m-2">
                                            <span class="badge bg-danger rounded-pill shadow-sm px-3 py-2">
                                                {% if offer.old_price %}
                                                {{ offer.discount_percentage }}% OFF
                                                {% else %}
                                                DEAL
                                                {% endif %}
                                            </span>
                                        </div>
                                    </div>
                                    {% endif %}
                                    <div class="card-body">
                                        <h5 class="fw-bold text-dark mb-1">{{ offer.title }}</h5>
                                        <p class="small text-muted mb-2 text-truncate">{{ offer.description }}</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <span class="fw-bold text-success h5 mb-0">{{ offer.new_price }}
                                                    <small>SAR</small></span>
                                                {% if offer.old_price %}
                                                <small class="text-muted text-decoration-line-through ms-2">{{ offer.old_price }}</small>
                                                {% endif %}
                                            </div>
                                            <small class="text-danger fw-bold">
                                                <i class="fas fa-clock me-1"></i> Ends {{ offer.end_date|date:"M d" }}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- About Section -->
                <div class="card border-0 shadow-sm rounded-4 mb-4 overflow-hidden">
                    <div class="card-body p-4 p-md-5">
                        <h3 class="fw-bold mb-4 text-primary">
                            <i class="fas fa-info-circle me-2"></i>{% trans "About" %} {{ place.name }}
                        </h3>
                        <p class="text-secondary lead lh-lg mb-4" style="text-align: justify;">
                            {{ place.description }}
                        </p>

                        <!-- Badges Section -->
                        <div class="d-flex flex-wrap gap-2 mb-4">
                            {% if place.road_condition %}
                            <span
                                class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25 rounded-pill px-3 py-2">
                                <i class="fas fa-road me-1"></i> {{ place.get_road_condition_display }}
                            </span>
                            {% endif %}

                            {% if place.classification %}
                            <span
                                class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25 rounded-pill px-3 py-2">
                                <i class="fas fa-users me-1"></i> {{ place.get_classification_display }}
                            </span>
                            {% endif %}

                            {% if place.best_season %}
                            <span
                                class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 rounded-pill px-3 py-2">
                                <i class="fas fa-cloud-sun me-1"></i> Best: {{ place.get_best_season_display }}
                            </span>
                            {% endif %}
                        </div>

                        <!-- Landmark Specifics -->
                        {% if place.landmark %} <!-- Check implicit reverse relation to Landmark -->
                        <div class="bg-light p-4 rounded-4 mb-3">
                            <h5 class="fw-bold mb-3"><i class="fas fa-landmark me-2 text-primary"></i>Visitor Info</h5>
                            <div class="row g-3">
                                {% if place.landmark.best_visit_time %}
                                <div class="col-md-6">
                                    <small class="text-muted d-block">Best Time</small>
                                    <span class="fw-bold">{{ place.landmark.best_visit_time }}</span>
                                </div>
                                {% endif %}
                                {% if place.landmark.safety_instructions %}
                                <div class="col-12">
                                    <small class="text-primary fw-bold d-block mb-1"><i
                                            class="fas fa-shield-alt me-1"></i>Safety Instructions</small>
                                    <p class="mb-0 small text-secondary">{{ place.landmark.safety_instructions }}</p>
                                </div>
                                {% endif %}
                                {% if place.landmark.photography_rules %}
                                <div class="col-12">
                                    <small class="text-muted d-block">Photography Rules</small>
                                    <span class="small">{{ place.landmark.photography_rules }}</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}

                    </div>
                </div>

                <!-- Gallery Section (Media) -->
                {% if place.media.exists %}
                <div class="card border-0 shadow-sm rounded-4 mb-4 overflow-hidden">
                    <div class="card-header bg-white border-0 p-4">
                        <h4 class="fw-bold mb-0 text-dark">
                            <i class="fas fa-images me-2 text-success"></i>{% trans "Gallery" %}
                        </h4>
                    </div>
                    <div class="card-body p-2">
                        <div class="row g-2">
                            <!-- Images -->
                            {% for item in place.media.all %}
                            {% if item.media_type == 'IMAGE' %}
                            <div class="col-6 col-md-4">
                                <a href="{{ item.media_url.url }}" data-lightbox="place-gallery"
                                    data-title="Gallery Image"
                                    class="d-block overflow-hidden rounded-3 position-relative group-hover">
                                    <img src="{{ item.media_url.url }}"
                                        class="img-fluid w-100 object-fit-cover hover-zoom"
                                        style="height: 200px; transition: transform 0.5s ease;" alt="Gallery">
                                    <div
                                        class="position-absolute top-0 start-0 w-100 h-100 bg-black bg-opacity-25 opacity-0 group-hover-opacity-100 d-flex align-items-center justify-content-center transition-all">
                                        <i class="fas fa-search-plus text-white fa-2x"></i>
                                    </div>
                                </a>
                            </div>
                            {% endif %}
                            {% endfor %}

                            <!-- Videos -->
                            {% for item in place.media.all %}
                            {% if item.media_type == 'VIDEO' %}
                            <div class="col-12 col-md-6">
                                <div class="rounded-3 overflow-hidden shadow-sm">
                                    <video controls class="w-100" style="height: 250px; object-fit: cover;">
                                        <source src="{{ item.media_url.url }}" type="video/mp4">
                                        Your browser does not support the video tag.
                                    </video>
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Units / Rooms Section -->
                {% if place.units.exists %}
                <div class="card border-0 shadow-sm rounded-4 mb-4 overflow-hidden">
                    <div class="card-header bg-white border-0 p-4 d-flex justify-content-between align-items-center">
                        <h4 class="fw-bold mb-0 text-dark">
                            <i class="fas fa-bed me-2 text-primary"></i>Availability
                        </h4>
                    </div>
                    <div class="card-body p-4 bg-light bg-opacity-25">
                        <div class="row g-3">
                            {% for unit in place.units.all %}
                            <div class="col-md-6">
                                <div class="card border-0 shadow-sm h-100 rounded-4 hover-lift transition-all">
                                    <div class="position-relative">
                                        {% if unit.image %}
                                        <img src="{{ unit.image.url }}" class="card-img-top object-fit-cover"
                                            style="height: 180px;" alt="{{ unit.name }}">
                                        {% else %}
                                        <img src="{% static 'images/placeholder.jpg' %}"
                                            class="card-img-top object-fit-cover" style="height: 180px;" alt="Unit">
                                        {% endif %}
                                        {% if unit.price %}
                                        <div class="position-absolute top-0 end-0 m-3">
                                            <span class="badge bg-white text-dark shadow-sm rounded-pill px-3 py-1">
                                                {{ unit.price }} IRR
                                            </span>
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="card-body">
                                        <h5 class="fw-bold text-dark mb-2">{{ unit.name }}</h5>
                                        <p class="small text-muted mb-3">{{ unit.description|truncatechars:60 }}</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-secondary"><i class="fas fa-tag me-1"></i> {{ unit.unit_type }}</small>
                                            <a href="#"
                                                class="btn btn-sm btn-outline-primary rounded-pill px-3">Details</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Similar Places Section -->
                {% if related_places %}
                <div class="card border-0 shadow-sm rounded-4 mb-4 overflow-hidden">
                    <div class="card-header bg-white border-0 p-4">
                        <h4 class="fw-bold mb-0 text-dark">
                            <i class="fas fa-compass me-2 text-primary"></i>{% trans "You Might Also Like" %}
                        </h4>
                    </div>
                    <div class="card-body p-4 bg-light bg-opacity-25">
                        <div class="row g-3">
                            {% for place in related_places %}
                            <div class="col-6 col-md-4">
                                <a href="{{ place.get_absolute_url }}" class="card h-100 border-0 shadow-sm hover-lift text-decoration-none text-dark">
                                    {% if place.cover_image %}
                                    <img src="{{ place.cover_image.url }}" class="card-img-top object-fit-cover" 
                                         style="height: 120px;" alt="{{ place.name }}">
                                    {% else %}
                                    <div class="bg-light d-flex align-items-center justify-content-center" style="height: 120px;">
                                        <i class="fas fa-image text-muted fa-2x"></i>
                                    </div>
                                    {% endif %}
                                    <div class="card-body p-3">
                                        <h6 class="fw-bold mb-1 text-truncate">{{ place.name }}</h6>
                                        <div class="small text-muted mb-1">
                                            <i class="fas fa-map-marker-alt me-1 text-danger"></i> {{ place.directorate }}
                                        </div>
                                        <div class="d-flex align-items-center small">
                                            <i class="fas fa-star text-warning me-1"></i>
                                            <span class="fw-bold">{{ place.avg_rating|default:"-" }}</span>
                                        </div>
                                    </div>
                                </a>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Reviews Section (Unified) -->
                {% include "places/detail/reviews.html" %}

                <!-- Nearby Services Section (Loaded via AJAX) -->
                <div class="card border-0 shadow-sm rounded-4 mb-4 overflow-hidden" id="nearby-section"
                    style="display: none;">
                    <div class="card-header bg-white border-0 p-4">
                        <h4 class="fw-bold mb-0 text-dark">
                            <i class="fas fa-map-marked-alt me-2 text-info"></i>{% trans "Nearby Services" %}
                        </h4>
                    </div>
                    <div class="card-body p-4 bg-light bg-opacity-25" id="nearby-services-container">
                        <!-- Content injected here -->
                        <div class="text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- RIGHT COLUMN (Sidebar) -->
            <div class="col-lg-4">
                <div class="sticky-top" style="top: 100px; z-index: 900;">

                    <!-- Map Card -->
                    <div class="card border-0 shadow-sm rounded-4 mb-4 overflow-hidden">
                        <div class="card-body p-0 position-relative">
                            <div id="map" style="height: 250px; width: 100%;"
                                data-lat="{{ place.latitude|default:'13.9667' }}"
                                data-lon="{{ place.longitude|default:'44.1833' }}"></div>
                            <div class="position-absolute bottom-0 end-0 m-3 d-flex gap-2">
                                <select id="travelMode"
                                    class="form-select form-select-sm shadow-sm rounded-pill border-0"
                                    style="width: auto;">
                                    <option value="driving">üöó Car</option>
                                    <option value="driving">üöô 4x4</option>
                                    <option value="walking">üö∂ Walking</option>
                                </select>
                                <button onclick="startNavigation()"
                                    class="btn btn-primary shadow-sm rounded-pill btn-sm fw-bold">
                                    <i class="fas fa-location-arrow me-1"></i> Go
                                </button>
                                <button onclick="showMyLocation()"
                                    class="btn btn-light shadow-sm rounded-pill btn-sm text-primary"
                                    title="ŸÖŸàŸÇÿπŸä ÿßŸÑÿ≠ÿßŸÑŸä">
                                    <i class="fas fa-crosshairs"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Official Licensing Card (New Compliance Feature) -->
                    {% if place.establishment and place.establishment.is_verified %}
                    <div class="card border-0 shadow-sm rounded-4 mb-4">
                        <div class="card-header bg-white border-0 py-3 d-flex align-items-center">
                            <i class="fas fa-certificate text-warning fa-lg me-2"></i>
                            <h6 class="fw-bold mb-0 text-dark">{% trans "Official Records" %}</h6>
                        </div>
                        <div class="card-body p-3">
                            <div
                                class="d-flex align-items-center mb-3 bg-success bg-opacity-10 p-2 rounded-3 text-success">
                                <i class="fas fa-check-circle me-2"></i>
                                <small class="fw-bold">Verified Establishment</small>
                            </div>

                            {% if place.establishment.license_number %}
                            <div class="d-flex justify-content-between mb-2 pb-2 border-bottom border-light">
                                <span class="text-muted small">{% trans "License No." %}</span>
                                <span class="fw-bold font-monospace small">{{ place.establishment.license_number }}</span>
                            </div>
                            {% endif %}

                            {% if place.establishment.commercial_registration %}
                            <div class="d-flex justify-content-between mb-0">
                                <span class="text-muted small">{% trans "Comm. Reg." %}</span>
                                <span class="fw-bold font-monospace small">{{ place.establishment.commercial_registration }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Contact Card -->
                    {% if grouped_contacts.phones or grouped_contacts.messaging or grouped_contacts.social or grouped_contacts.links %}
                    <div class="card border-0 shadow-sm rounded-4 mb-4">
                        <div class="card-body p-4">
                            {% include 'components/contacts_display.html' with contacts=grouped_contacts %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Sidebar Ad (Lazy Loaded) -->
                    <div hx-get="{% url 'ad_slot' 'sidebar' %}"
                         hx-trigger="load"
                         hx-swap="innerHTML"></div>

                    <!-- Weather Widget -->
                    <div id="weather-widget" class="card border-0 shadow-sm rounded-4 mb-4 bg-primary text-white"
                        style="display: none; background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);">
                        <div class="card-body p-4" id="weather-content">
                            <!-- Weather Content -->
                        </div>
                    </div>


                    <!-- Reviews removed from sidebar to avoid duplication -->

                    <!-- Comments Section (Phase 3) -->
                    <hr class="my-5 border-light">
                    {% include 'places/detail/comments.html' %}

                    <!-- Report Button -->
                    <div class="text-center">
                        <button data-bs-toggle="modal" data-bs-target="#reportModal"
                            class="btn btn-link text-muted btn-sm">
                            <i class="fas fa-flag me-1"></i> Report this place
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>



<!-- Report Modal -->
<div class="modal fade" id="reportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content rounded-4 border-0 shadow-lg" style="overflow: hidden;">
            <div class="modal-header border-0 bg-danger text-white p-3 p-md-4">
                <h5 class="modal-title fw-bold"><i class="fas fa-exclamation-triangle me-2"></i> {% trans "Report Issue" %}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-3 p-md-4">
                {% if user.is_authenticated %}
                <form hx-post="{% url 'report_place' place.pk %}" 
                      hx-encoding="multipart/form-data" 
                      hx-target="#reportModal .modal-body"
                      hx-swap="innerHTML">
                    {% csrf_token %}
                    
                    <!-- Report Type -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">{% trans "What is the issue?" %}</label>
                        <select name="report_type" class="form-select form-select-lg rounded-pill mb-3" required>
                            <option value="INACCURATE">{% trans "Incorrect Information" %}</option>
                            <option value="SPAM">{% trans "Spam or Scam" %}</option>
                            <option value="INAPPROPRIATE">{% trans "Inappropriate Content" %}</option>
                            <option value="SAFETY">{% trans "Safety Concern" %}</option>
                            <option value="COPYRIGHT">{% trans "Copyright Violation" %}</option>
                            <option value="OTHER">{% trans "Other" %}</option>
                        </select>
                    </div>

                    <!-- Description -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">{% trans "Details" %}</label>
                        <textarea name="description" class="form-control rounded-4" rows="4" 
                            placeholder="{% trans 'Please provide more details...' %}" required></textarea>
                    </div>

                    <!-- Proof Image (Optional) -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">{% trans "Proof Image (Optional)" %}</label>
                        <input type="file" name="proof_image" class="form-control rounded-pill" accept="image/*">
                        <div class="form-text">{% trans "Upload a screenshot or photo if helpful." %}</div>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-danger btn-lg rounded-pill shadow-sm hover-lift">
                            {% trans "Submit Report" %}
                        </button>
                    </div>
                </form>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-lock fa-3x text-muted mb-3 opacity-50"></i>
                    <h5 class="fw-bold mb-3">{% trans "Login Required" %}</h5>
                    <p class="mb-4 text-muted">{% trans "You must be logged in to report a place." %}</p>
                    <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-primary btn-lg rounded-pill px-5 shadow-sm">
                        {% trans "Login Now" %}
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
    /* Mobile enhancements for modal */
    @media (max-width: 576px) {
        #reportModal .modal-dialog {
            margin: 0.5rem;
            width: auto;
        }
        #reportModal .modal-content {
            border-radius: 1rem !important; /* Slightly smaller radius on mobile */
        }
    }
</style>

<style>
    .backdrop-blur {
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }

    .text-shadow {
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }

    .hover-lift {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .hover-lift:hover {
        transform: translateY(-5px);
        box-shadow: 0 .5rem 1rem rgba(0, 0, 0, .15) !important;
    }

    .hover-zoom {
        transition: transform 0.3s ease;
    }

    .group-hover:hover .hover-zoom {
        transform: scale(1.05);
    }

    .group-hover-opacity-100:hover {
        opacity: 1 !important;
    }

    /* Rating Stars */
    .rating-select .fa-star {
        transition: transform 0.2s;
    }

    .rating-select .fa-star:hover {
        transform: scale(1.2);
    }
</style>

<!-- SCRIPTS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<script>
    // Global functions for button handlers
    function showMyLocation() {
        if (window.placeMap) {
            window.placeMap.locate({setView: true, maxZoom: 16});
            window.placeMap.on('locationfound', function(e) {
                var radius = e.accuracy / 2;
                L.marker(e.latlng).addTo(window.placeMap)
                    .bindPopup("ŸÖŸàŸÇÿπŸÉ ÿßŸÑÿ≠ÿßŸÑŸä (" + Math.round(radius) + "m)").openPopup();
                L.circle(e.latlng, radius).addTo(window.placeMap);
            });
            window.placeMap.on('locationerror', function(e) {
                alert("ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ÿØŸäÿØ ŸÖŸàŸÇÿπŸÉ: " + e.message);
            });
        }
    }

    function startNavigation() {
        // Use data attributes from the map element for safety
        var mapElement = document.getElementById('map');
        var lat = mapElement.getAttribute('data-lat');
        var lon = mapElement.getAttribute('data-lon');
        var url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`;
        window.open(url, '_blank');
    }

    document.addEventListener('DOMContentLoaded', function () {
        // --- MAP INITIALIZATION ---
        var mapElement = document.getElementById('map');
        var lat = parseFloat(mapElement.getAttribute('data-lat')) || 13.9667;
        var lon = parseFloat(mapElement.getAttribute('data-lon')) || 44.1833;

        var map = L.map('map').setView([lat, lon], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        L.marker([lat, lon]).addTo(map)
            .bindPopup('{{ place.name|escapejs }}')
            .openPopup();

        window.placeMap = map; // Expose to global scope for button

        // --- NEARBY PLACES FETCH ---
        fetchNearbyPlaces(lat, lon);

        // --- WEATHER FETCH ---
        fetchWeather(lat, lon);
    });

    function fetchWeather(lat, lon) {
        const widget = document.getElementById('weather-widget');
        const content = document.getElementById('weather-content');

        fetch(`/places/weather/?lat=${lat}&lon=${lon}`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const current = data.current;
                    const forecast = data.forecast.slice(1, 4); // Next 3 days

                    let html = `
                        <div class="d-flex justify-content-center align-items-center mb-3">
                            <img src="https://openweathermap.org/img/wn/${current.icon}@2x.png" width="60" height="60">
                            <div class="text-start ms-2">
                                <h2 class="display-5 fw-bold mb-0 text-white">${current.temp}¬∞</h2>
                                <p class="mb-0 small text-white-50">${current.condition}</p>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between pt-3 border-top border-white border-opacity-25">
                    `;

                    forecast.forEach(day => {
                        const dateObj = new Date(day.date);
                        const dayName = dateObj.toLocaleDateString('ar-SA', { weekday: 'short' });

                        html += `
                            <div class="text-center">
                                <p class="mb-0 small fw-bold text-white">${dayName}</p>
                                <img src="https://openweathermap.org/img/wn/${day.icon}.png" width="30" height="30">
                                <p class="mb-0 small text-white">${day.temp}¬∞</p>
                            </div>
                        `;
                    });

                    html += `</div>`;

                    content.innerHTML = html;
                    widget.style.display = 'block';
                } else {
                    console.log('Weather API Error:', data.message);
                    widget.style.display = 'none';
                }
            })
            .catch(err => {
                console.error('Weather Fetch Error:', err);
                widget.style.display = 'none';
            });
    }

    function fetchNearbyPlaces(lat, lon) {
        const container = document.getElementById('nearby-services-container');
        const section = document.getElementById('nearby-section');

        fetch(`/api/nearby/?lat=${lat}&lon=${lon}`)
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.text();
            })
            .then(html => {
                if (html.trim().length > 0) {
                    container.innerHTML = html;
                    section.style.display = 'block';
                } else {
                    container.innerHTML = '<p class="text-center text-muted">No nearby places found.</p>';
                }
            })
            .catch(error => {
                console.error('Error fetching nearby places:', error);
                container.innerHTML = '<p class="text-center text-danger small">Failed to load nearby places.</p>';
            });
    }

    function scrollToReview() {
        const reviewSection = document.getElementById('reviews-section');
        if (reviewSection) {
            reviewSection.scrollIntoView({ behavior: 'smooth' });
        }
    }

    function sharePlace() {
        const shareData = {
            title: '{{ place.name|escapejs }}',
            text: 'ÿßŸÉÿ™ÿ¥ŸÅ Ÿáÿ∞ÿß ÿßŸÑŸÖŸÉÿßŸÜ ÿßŸÑŸÖŸÖŸäÿ≤ ŸÅŸä ÿ•ÿ®!',
            url: window.location.href,
        };
        
        if (navigator.share) {
            navigator.share(shareData).catch(function(err) {
                if (err.name !== 'AbortError') {
                    copyToClipboard(shareData.url);
                }
            });
        } else {
            copyToClipboard(shareData.url);
        }
    }
    
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(function() {
            var toast = document.createElement('div');
            toast.className = 'position-fixed bottom-0 start-50 translate-middle-x mb-4 alert alert-success shadow-lg rounded-pill px-4 py-2 animate__animated animate__fadeInUp';
            toast.style.zIndex = '9999';
            toast.innerHTML = '<i class="fas fa-check-circle me-2"></i> ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑ ÿ®ŸÜÿ¨ÿßÿ≠!';
            document.body.appendChild(toast);
            setTimeout(function() { toast.remove(); }, 3000);
        }).catch(function() {
            prompt('ÿßŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑:', text);
        });
    }
</script>
{% endblock %}
