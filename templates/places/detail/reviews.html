<section id="reviews-section" class="mb-5">
    <div class="container">
        <h3 class="fw-bold mb-4">آراء الزوار</h3>

        <!-- 1. Rating Summary -->
        {% include "places/partials/rating_summary.html" %}

        <!-- 2. Review Form -->
        <div id="review-form" class="card border-0 shadow-sm rounded-4 p-4 mb-4">
            {% if user.is_authenticated %}
            <form hx-post="{% url 'review_create' place.pk %}" 
                  hx-target="#reviews-list" 
                  hx-swap="innerHTML"
                  hx-indicator="#review-indicator">
                {% csrf_token %}
                <div class="mb-3">
                    <label class="form-label fw-bold">تقييمك</label>
                    <div class="rating-select d-flex gap-2 text-warning fs-4" style="cursor: pointer;">
                        <i class="far fa-star" data-val="1"></i>
                        <i class="far fa-star" data-val="2"></i>
                        <i class="far fa-star" data-val="3"></i>
                        <i class="far fa-star" data-val="4"></i>
                        <i class="far fa-star" data-val="5"></i>
                    </div>
                    <input type="hidden" name="rating" id="ratingInput" value="5">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">تعليقك</label>
                    <textarea name="comment" class="form-control rounded-3" rows="3" placeholder="اكتب تجربتك هنا..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary rounded-pill px-5">
                    إرسال التقييم
                    <span id="review-indicator" class="htmx-indicator spinner-border spinner-border-sm ms-2"></span>
                </button>
            </form>
            {% else %}
            <div class="text-center py-3">
                <p class="text-muted">يجب عليك تسجيل الدخول لإضافة تقييم.</p>
                <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-outline-primary rounded-pill">تسجيل الدخول</a>
            </div>
            {% endif %}
        </div>

        <!-- 3. Reviews List -->
        {% include "places/partials/reviews_list.html" %}
    </div>
</section>

<script>
    function initReviewStars() {
        const stars = document.querySelectorAll('.rating-select i');
        const input = document.getElementById('ratingInput');
        if (!stars.length || !input) return;
        
        function updateStars(val) {
            stars.forEach(s => {
                if (parseInt(s.dataset.val) <= parseInt(val)) {
                    s.classList.replace('far', 'fas');
                } else {
                    s.classList.replace('fas', 'far');
                }
            });
        }

        stars.forEach(star => {
            star.addEventListener('click', function() {
                input.value = this.dataset.val;
                updateStars(this.dataset.val);
            });
        });
        
        updateStars(input.value);
    }

    document.addEventListener('DOMContentLoaded', initReviewStars);
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target.id === "reviews-list") {
            // Re-init any dynamic elements if needed
        }
    });

    document.body.addEventListener('htmx:afterRequest', function(evt) {
        if (evt.detail.target.id === "reviews-list" && evt.detail.successful) {
            const form = document.querySelector('#review-form form');
            if (form) {
                form.reset();
                const input = document.getElementById('ratingInput');
                if (input) input.value = 5;
                initReviewStars();
            }
        }
    });

    function toggleReplyForm(id) {
        const form = document.getElementById(id);
        if (form) {
            form.classList.toggle('d-none');
            if (!form.classList.contains('d-none')) {
                form.querySelector('textarea')?.focus();
            }
        }
    }
</script>

<style>
    .cursor-pointer { cursor: pointer; }
    .transition-transform { transition: transform 0.3s ease; }
    .rating-select i { transition: transform 0.1s ease; }
    .rating-select i:hover { transform: scale(1.2); }
</style>