{% extends "base_marketing.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}تسجيل زائر جديد - دليل إب{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/modern_auth.css' %}">
{% endblock %}

{% block content %}
<div class="auth-split-wrapper animate__animated animate__fadeIn">
    <!-- Right Side: Form -->
    <div class="auth-split-form">
        <div class="auth-split-form-inner">
            <div class="auth-header text-start mb-4">
                <div class="auth-logo mb-4 bg-success text-white border-0 shadow-lg"
                    style="width: 60px; height: 60px; font-size: 1.5rem; border-radius: 16px;">
                    <i class="fas fa-hiking"></i>
                </div>
                <h2 class="auth-title mb-2">أهلاً بك في إب!</h2>
                <p class="auth-subtitle">أنشئ حسابك المجاني واستمتع بتجربة سياحية فريدة.</p>
            </div>

            <!-- Messages/Errors -->
            {% if form.non_field_errors %}
            {% for error in form.non_field_errors %}
            <div class="alert alert-danger d-flex align-items-center mb-4 rounded-3 border-danger">
                <i class="fas fa-exclamation-circle me-2"></i>
                <div>{{ error }}</div>
            </div>
            {% endfor %}
            {% endif %}

            <form method="post" class="needs-validation" novalidate id="signupForm">
                {% csrf_token %}



                <div class="form-floating mb-3">
                    <input type="text" name="username" class="form-control" id="id_username" placeholder="اسم المستخدم"
                        required value="{{ form.username.value|default:'' }}">
                    <label for="id_username"><i class="fas fa-at me-2 text-muted"></i>اسم المستخدم</label>
                    <div class="form-text small">يجب أن يكون بالإنجليزية وأرقام فقط.</div>
                    {% if form.username.errors %}
                    <div class="text-danger small mt-1">{{ form.username.errors.0 }}</div>
                    {% endif %}
                </div>

                <div class="form-floating mb-3">
                    <input type="email" name="email" class="form-control" id="id_email" placeholder="name@example.com"
                        required value="{{ form.email.value|default:'' }}" dir="ltr">
                    <label for="id_email"><i class="fas fa-envelope me-2 text-muted"></i>البريد الإلكتروني</label>
                    {% if form.email.errors %}
                    <div class="text-danger small mt-1">{{ form.email.errors.0 }}</div>
                    {% endif %}
                </div>



                <div class="form-floating mb-3 position-relative">
                    <input type="password" name="password1" class="form-control" id="id_password1"
                        placeholder="كلمة المرور" required>
                    <label for="id_password1"><i class="fas fa-lock me-2 text-muted"></i>كلمة المرور</label>
                    <span class="position-absolute top-50 end-0 translate-middle-y me-3" 
                          style="cursor: pointer; z-index: 10;" 
                          onclick="togglePassword('id_password1', this)">
                        <i class="fas fa-eye text-muted"></i>
                    </span>
                    {% if form.password1.errors %}
                    <div class="text-danger small mt-1">{{ form.password1.errors.0 }}</div>
                    {% endif %}
                    <!-- Password Strength Meter -->
                    <div class="password-strength mt-2" id="passwordStrength" style="display: none;">
                        <div class="d-flex align-items-center gap-2">
                            <div class="progress flex-grow-1" style="height: 6px;">
                                <div class="progress-bar" id="strengthBar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <span class="badge" id="strengthText" style="min-width: 60px;"></span>
                        </div>
                        <ul class="list-unstyled small mt-2 mb-0 text-muted" id="passwordRequirements">
                            <li id="req-length"><i class="fas fa-circle me-1" style="font-size: 6px;"></i> 8 أحرف على
                                الأقل</li>
                            <li id="req-upper"><i class="fas fa-circle me-1" style="font-size: 6px;"></i> حرف كبير</li>
                            <li id="req-lower"><i class="fas fa-circle me-1" style="font-size: 6px;"></i> حرف صغير</li>
                            <li id="req-number"><i class="fas fa-circle me-1" style="font-size: 6px;"></i> رقم واحد</li>
                        </ul>
                    </div>
                </div>

                <div class="form-floating mb-4">
                    <input type="password" name="password2" class="form-control" id="id_password2"
                        placeholder="تأكيد كلمة المرور" required>
                    <label for="id_password2"><i class="fas fa-check-circle me-2 text-muted"></i>تأكيد كلمة
                        المرور</label>
                    {% if form.password2.errors %}
                    <div class="text-danger small mt-1">{{ form.password2.errors.0 }}</div>
                    {% endif %}
                    <!-- Password Match Indicator -->
                    <div class="small mt-1" id="passwordMatch" style="display: none;"></div>
                </div>

                <div class="form-check mb-4">
                <input class="form-check-input" type="checkbox" name="terms_accepted" value="on" id="termsCheck" required>
                    <label class="form-check-label small text-muted" for="termsCheck">
                        أوافق على <a href="#" class="text-success fw-bold text-decoration-none">شروط الاستخدام</a> و <a
                            href="#" class="text-success fw-bold text-decoration-none">سياسة الخصوصية</a>
                    </label>
                </div>

                <button type="submit" class="btn-auth mt-0 bg-success border-0" id="submitBtn"
                    style="background: linear-gradient(135deg, #059669 0%, #10b981 100%);">
                    <span class="btn-text">إنشاء الحساب</span>
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                </button>
            </form>

            <div class="text-center mt-4">
                <p class="text-muted small">لديك حساب بالفعل؟ <a href="{% url 'login' %}"
                        class="fw-bold text-success text-decoration-none">تسجيل الدخول</a></p>
            </div>
        </div>
    </div>

    <!-- Left Side: Image -->
    <div class="auth-split-media"
        style="background-image: url('https://images.unsplash.com/photo-1542259659-4fa22e505221?ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80');">
        <div class="auth-quote animate__animated animate__fadeInUp">
            <h2>شاركنا مغامرتك.</h2>
            <p class="fs-5 opacity-75">انضم لمجتمع إب السياحي، قيم الأماكن، وشارك صورك مع العالم.</p>
        </div>
    </div>
</div>

<script>
    // Password Strength Meter
    const password1 = document.getElementById('id_password1');
    const password2 = document.getElementById('id_password2');
    const strengthContainer = document.getElementById('passwordStrength');
    const strengthBar = document.getElementById('strengthBar');
    const strengthText = document.getElementById('strengthText');
    const matchIndicator = document.getElementById('passwordMatch');

    function checkPasswordStrength(password) {
        let score = 0;
        const requirements = {
            length: password.length >= 8,
            upper: /[A-Z]/.test(password),
            lower: /[a-z]/.test(password),
            number: /\d/.test(password),
            special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
        };

        // Update requirement indicators
        ['length', 'upper', 'lower', 'number'].forEach(req => {
            const el = document.getElementById('req-' + req);
            if (el) {
                const icon = el.querySelector('i');
                if (requirements[req]) {
                    el.classList.remove('text-muted');
                    el.classList.add('text-success');
                    icon.classList.remove('fa-circle');
                    icon.classList.add('fa-check-circle');
                } else {
                    el.classList.remove('text-success');
                    el.classList.add('text-muted');
                    icon.classList.remove('fa-check-circle');
                    icon.classList.add('fa-circle');
                }
            }
        });

        // Calculate score
        if (requirements.length) score++;
        if (requirements.upper) score++;
        if (requirements.lower) score++;
        if (requirements.number) score++;
        if (requirements.special) score++;

        return score;
    }

    function updateStrengthMeter(score) {
        const levels = [
            { width: '20%', class: 'bg-danger', text: 'ضعيفة جداً', badge: 'bg-danger' },
            { width: '40%', class: 'bg-warning', text: 'ضعيفة', badge: 'bg-warning' },
            { width: '60%', class: 'bg-info', text: 'متوسطة', badge: 'bg-info' },
            { width: '80%', class: 'bg-primary', text: 'جيدة', badge: 'bg-primary' },
            { width: '100%', class: 'bg-success', text: 'قوية', badge: 'bg-success' }
        ];

        const level = levels[Math.min(score, 4)];
        strengthBar.style.width = level.width;
        strengthBar.className = 'progress-bar ' + level.class;
        strengthText.textContent = level.text;
        strengthText.className = 'badge ' + level.badge;
    }

    password1.addEventListener('input', function () {
        const password = this.value;
        if (password.length > 0) {
            strengthContainer.style.display = 'block';
            const score = checkPasswordStrength(password);
            updateStrengthMeter(score);
        } else {
            strengthContainer.style.display = 'none';
        }
        checkPasswordMatch();
    });

    password2.addEventListener('input', checkPasswordMatch);

    function checkPasswordMatch() {
        if (password2.value.length > 0) {
            matchIndicator.style.display = 'block';
            if (password1.value === password2.value) {
                matchIndicator.innerHTML = '<i class="fas fa-check-circle text-success me-1"></i> كلمتا المرور متطابقتان';
                matchIndicator.className = 'small mt-1 text-success';
            } else {
                matchIndicator.innerHTML = '<i class="fas fa-times-circle text-danger me-1"></i> كلمتا المرور غير متطابقتين';
                matchIndicator.className = 'small mt-1 text-danger';
            }
        } else {
            matchIndicator.style.display = 'none';
        }
    }

    // Form submission
    document.getElementById('signupForm').addEventListener('submit', function (e) {
        if (this.checkValidity()) {
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.querySelector('.btn-text').innerHTML = 'جاري الإنشاء...';
            btn.querySelector('.spinner-border').classList.remove('d-none');
        }
    });
    // Password Toggle
    function togglePassword(inputId, iconSpan) {
        const input = document.getElementById(inputId);
        const icon = iconSpan.querySelector('i');
        
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }
</script>
{% endblock %}